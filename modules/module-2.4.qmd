---
title: "Module 2.4"
subtitle: "Joining Data Frames"
format: 
  html:
    code-link: true
highlight-style: atom-one
execute: 
  echo: true
  message: false
  warning: false
---

::: {.callout-tip}
## Prework

- Start a QMD file for this module.
- Install the `WDI` package and study [the documentation](https://vincentarelbundock.github.io/WDI/)
- Visit the [World Development Indicators database](https://databank.worldbank.org/source/world-development-indicators) and explore the available indicators.
- Install the `countrycode` package and [read about it](https://vincentarelbundock.github.io/countrycode/).
- Read about [mutating joins](https://dplyr.tidyverse.org/reference/mutate-joins.html) in `dplyr`.
:::

## Overview

In this module, we will learn how to join data frames in R using the `dplyr` package. Joining data frames is a fundamental operation in data analysis, allowing you to combine information from different sources based on common keys. We will explore various types of joins, including inner joins, left joins, right joins, and full joins, and apply a left join to merge two real-world datasets. 


## Packages for API Data

As more organizations publish their data online, APIs—Application Programming Interfaces—have become a standard way to provide structured access to that information. Rather than downloading spreadsheets or scraping websites, we can use R code to request data directly from a server and receive it in a tidy format.

In R, a growing number of packages are designed specifically to help you access data from these APIs. These tools handle the technical details of connecting to the API and parsing the response, so you can focus on analysis. Packages like `WDI` and `wbstats` (for World Bank data), `fredr` (for U.S. Federal Reserve data), and `tidycensus` (for U.S. Census data) make it much easier to pull data into your workflow with just a few lines of code.

In this module, we will use the `WDI` package by Vincent Arel-Bundock to access data from the World Bank’s open data API. The package provides a streamlined interface to over 40 datasets published by the World Bank, including the World Development Indicators, Gender Statistics, Education Statistics, and more. These databases cover a wide range of topics such as health, labor, infrastructure, environment, and governance, with data available for nearly every country in the world. The package returns the data in a tidy format, making it easy to integrate into your analysis workflow.

The basic syntax for using the `WDI` package is as follows:

```{r}
library(WDI)
library(dplyr)

wbdata <- WDI(
  indicator = "NY.GDP.MKTP.CD", # GDP in current US dollars
  country = c("USA", "CAN", "MEX"), # Countries to include
  start = 2000, # Start year
  end = 2020, # End year
  extra = FALSE # Include extra metadata (default is FALSE)
)

glimpse(wbdata)
```


::: {.callout-important}
## ISO Country Codes
The `country` parameter takes either ISO aplha 2 or 3 codes which you can find [here](https://www.iban.com/country-codes). Familiarize yourself with these codes a bit as they will become important when we want merge datasets based on them.
:::

If you want to download multiple indicators at once, you can pass a vector of indicator codes to the `indicator` parameter. You can also rename variables as you select them. For example:

```{r}
indicators <- c(gdp = "NY.GDP.MKTP.CD", population = "SP.POP.TOTL") 

wbdata2 <- WDI(
  indicator = indicators, # GDP and total pop
  country = c("USA", "CAN", "MEX"),
  start = 2000,
  end = 2020
)

glimpse(wbdata2)
```

There are two ways to find indicators to download with `WDI`. One is to use the built-in `WDIsearch()` function to search for indicators by keyword, like this: 

```{r}
WDIsearch('labor force participation') |> 
  as_tibble() |> # Convert to tibble for easier viewing
  slice(1:10) # Show first 10 results
```

Or with regular expressions like this:

```{r}
WDIsearch('labor.*participation.*female') |>
    as_tibble() |> 
    slice(1:10) 
```

::: {.callout-note}
A regular expression (or regex) is a special pattern used to match text. In WDIsearch(), regular expressions let you search for indicators based on the presence and order of words. For example, the pattern "labor.\*participation.\*female" matches any indicator name that contains the word "labor," followed by "participation," and then "female," with any characters in between. See [this chapter](https://r4ds.hadley.nz/regexps) of *R for Data Science* for more on regular expressions.
:::

Note that here we are using the `dplyr` `slice()` function to limit the results to the first 10 rows. You can adjust this number as needed. The output will show you the indicator name, code, and description, which you can use in the `WDI()` function. We also convert the output to a tibble for easier viewing in a rendered Quarto document (but this is not necessary in a notebook or in the console).

The other way you can hunt for indicators is to browse the World Bank's [World Development Indicators database](https://databank.worldbank.org/source/world-development-indicators) directly. Here you can go to the Series tab and simply search for the indicator you are interested in. Then click on the information icon to view the indicator's code, which you can use in the `WDI()` function.

::: {.callout-warning icon=false}
## Your Turn!!

- Use `WDIsearch()` to find an indicator of interest.
- Use `WDI()` to download that variable for a country or set of countries.
- Use `WDI()` to download multiple indicators at once.
:::

## Joining Datasets

Now let's say that we have downloaded some data from the World Bank with `WDI` and now we want to merge it with another dataset. For example, we might want to analyze the relationship between some economic indicators like GDP and population, and some political indicators like democracy scores from the V-Dem dataset. To do this, we need to join the two datasets together based on a **common key**, which in this case is the country code.

When we talk about a join in data wrangling, we are usually referring to a horizontal merge—that is, combining two data frames side by side by matching rows based on shared values in one or more columns (like country and year). This is common when we have data from two different sources, such as World Bank and V-Dem, and we want to analyze them together.

In dplyr, the most common joins fall into two categories: mutating joins and filtering joins. Mutating joins are the ones you’ll use most often when combining datasets. There are four main types.

An **inner join** keeps only the rows that match in both datasets. If a country-year pair is missing in either dataset, it will be dropped from the result.

![*Source: R for HR*](images/inner_join.png)

A **full join** keeps everything from both datasets. If a country-year pair exists in only one of them, you’ll still see it in the final data, with missing values (NA) filled in where needed.

![*Source: R for HR*](images/full_join.png)

A **left join** keeps all rows from the left dataset (typically the one you're focusing your analysis on) and adds columns from the right dataset wherever there’s a match.

![*Source: R for HR*](images/left_join.png)

A **right join** is like a left join, but it keeps all rows from the right dataset and adds data from the left wherever possible.

![*Source: R for HR*](images/right_join.png)

Most of the time, we will use a left join because we want to keep the structure of one main dataset and supplement it with additional information. The syntax for a left join in dplyr is straightforward:

```{r}
#| eval: false

left_join(data1, data2, by = "common_column")
```

## Common Keys (and the `countrycode` Package)

That brings us to our next point, which is that when we are joining datasets, it’s crucial to ensure that the columns you’re joining on have the same data type and format. For example, if one dataset uses ISO alpha-3 country codes (like "USA") and another uses alpha-2 codes (like "US"), you’ll need to standardize them before joining. 

In the context of cross-country analysis, the `countrycode` package (also authored by Vincent Arel-Bundock) is immensely helpful. It allows you to convert between different country code formats, such as ISO alpha-2, alpha-3, numeric codes, and even country names. 

To convert country codes using the `countrycode` package, you can use `mutate()` along with the `countrycode()` function. Let's try it with the `wbdata` dataset we created earlier:

```{r}
library(countrycode)

# Convert World Bank ISO alpha-2 codes to V-Dem alpha-3 codes
wbdata_with_vdem_codes <- wbdata |> 
  mutate(vdem_country_code = countrycode(
    sourcevar = iso3c, 
    origin = "wb", 
    destination = "vdem")
    ) |>
  relocate(vdem_country_code, .after = iso3c)

glimpse(wbdata_with_vdem_codes)
```

Here we are adding a new column to our `wbdata` dataset called `vdem_country_code`, which contains the V-Dem alpha-3 codes corresponding to the ISO alpha-2 codes in the `iso2c` column. The first argument in the `countrycode()` function is the vector of country codes that we want to convert, the second is the source code type (in this case, World Bank style iso3c codes or "wb"), and the third is the target code type (in this case, "vdem"). We also use the `dplyr` `relocate()` verb to move the new `vdem_country_code` column right after the original `iso3c` column for better organization.

## Performing the Join

{{< video https://youtu.be/wNF3ZPneHWw?si=TyiXrsAxgbdrztD4 title='Merge Two Data Frames with left_join()' >}}

Now that we have our `wbdata` dataset with the V-Dem country codes, we can perform a left join with the V-Dem data. Let’s go ahead and use our skills from the last lesson to download the V-Dem data for the same countries and years as our World Bank data. We will use the `fetchdem()` function to get the democracy scores for the same countries and years as our World Bank data.

```{r}
library(vdemlite)

# Fetch democracy scores for the same countries and years as wbdata
democracy_scores <- fetchdem(
  indicators = c("v2x_polyarchy", "v2xel_frefair"),
  start_year = 2000, end_year = 2020
)

glimpse(democracy_scores)
```

Now we can perform a left join to combine the two datasets based on the V-Dem country codes and the year. We will use the `left_join()` function from `dplyr` to do this:

```{r}
# Perform a left join to combine the datasets
wb_democracy_data <- left_join(
  wbdata_with_vdem_codes, 
  democracy_scores, 
  by = c("vdem_country_code" = "country_id", "year" = "year")
)

glimpse(wb_democracy_data)
```

Notice here that while we had a common key for the country codes, the columns had different names. Therefore, we specified the `by` argument as a named vector, where we matched the `vdem_country_code` from the World Bank data to the `country_code` in the V-Dem data. Note that we also had to specify the year as a second key for the join. This is because both datasets have a `year` column that we want to match on as well.

::: {.callout-warning icon=false}
## Your Turn!!
- Use the `WDI()` function to download a set of economic indicators for a country or set of countries.
- Use the `countrycode` package to convert the country codes in your World Bank data to V-Dem codes.
- Use the `fetchdem()` function to download V-Dem democracy scores for the same countries and years as your World Bank data.
- Use `left_join()` to merge the two datasets based on the V-Dem country codes and year.
:::

